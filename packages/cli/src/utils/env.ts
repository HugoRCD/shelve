import fs from 'fs'
import type { Env, VariablesCreateInput } from '@shelve/types'
import { cancel } from '@clack/prompts'

import consola from 'consola'
import { useApi } from './api'

const api = await useApi()

export function isEnvFileExist(): boolean {
  return fs.existsSync('.env')
}

export function appendEnvFile(variables: Env = []): void {
  const envFile = getEnvFile()
  envFile.push(...variables)
  const content = envFile.map((item) => `${ item.key }=${ item.value }`).join('\n')
  const finalString = `# Generated by Shelve CLI\n${content}`
  fs.writeFileSync('.env', finalString)
  consola.success('.env file updated successfully')
}

export function createEnvFile(variables: Env = []): void {
  if (isEnvFileExist()) {
    appendEnvFile(variables)
    return
  }
  const content = variables.map((item) => `${ item.key }=${ item.value }`).join('\n')
  const finalString = `# Generated by Shelve CLI\n${content}`
  if (isEnvFileExist()) fs.unlinkSync('.env')
  fs.writeFileSync('.env', finalString)
  consola.success('.env file created successfully')
}

export function getEnvFile(): Env[] {
  const isExist = fs.existsSync('.env')
  if (isExist) {
    const envFile = fs.readFileSync('.env', 'utf8')
    const envFileContent = envFile.split('\n').filter((item) => item && !item.startsWith('#')).join('\n')
    return envFileContent.split('\n').map((item) => {
      const [key, value] = item.split('=')
      if (!key || !value) {
        cancel('Invalid .env file')
        process.exit(0)
      }
      return { key, value }
    })
  }
  return []
}

export async function pushProjectVariable(projectId: number, environment: string): Promise<void> {
  consola.start(`Pushing variables for ${environment} environment`)
  try {
    const variables = getEnvFile()
    const body: VariablesCreateInput = {
      projectId,
      variables: variables.map((variable) => ({
        key: variable.key,
        value: variable.value,
        projectId,
        environment
      }))
    }
    await api(`/variable`, {
      method: 'POST',
      body
    })
  } catch (error) {
    process.exit(1)
  }
}
